(()=>{"use strict";function t(t){const e=t.replace(/^\[/,"").replace(/\]$/,"").split(",");if(2!==e.length)throw new Error("Invalid coordinate format");const i=parseFloat(e[0].trim()),s=parseFloat(e[1].trim());if(isNaN(i)||isNaN(s))throw new Error("Invalid coordinate format");if(i<-90||i>90||s<-180||s>180)throw new Error("Coordinates out of range");return{latitude:i,longitude:s}}class e{constructor(t){this.element=t,this.input=t.querySelector("#manual-coords"),this.okBtn=t.querySelector("#modal-ok"),this.cancelBtn=t.querySelector("#modal-cancel")}show(){return this.element.classList.remove("hidden"),this.input.value="",this.input.classList.remove("invalid"),new Promise((e,i)=>{const s=()=>{this.okBtn.removeEventListener("click",r),this.cancelBtn.removeEventListener("click",o),this.element.classList.add("hidden")},r=()=>{const i=this.input.value;try{t(i),s(),e(i)}catch(t){this.input.classList.add("invalid")}},o=()=>{s(),i(new Error("User cancelled"))};this.okBtn.addEventListener("click",r),this.cancelBtn.addEventListener("click",o)})}}class i{constructor(t,e){this.startBtn=t.querySelector("#audio-start"),this.ui=t.querySelector("#audio-recorder-ui"),this.okBtn=t.querySelector("#audio-ok"),this.cancelBtn=t.querySelector("#audio-cancel"),this.timerEl=t.querySelector("#audio-timer"),this.onSaveCallback=e,this.stream=null,this.recorder=null,this.chunks=[],this.timerInterval=null,this.seconds=0}init(){this.startBtn.addEventListener("click",()=>this.startRecording()),this.okBtn.addEventListener("click",()=>this.stopRecording(!0)),this.cancelBtn.addEventListener("click",()=>this.stopRecording(!1))}async startRecording(){if(navigator.mediaDevices)try{this.stream=await navigator.mediaDevices.getUserMedia({audio:!0}),this.recorder=new MediaRecorder(this.stream),this.chunks=[],this.recorder.addEventListener("dataavailable",t=>{this.chunks.push(t.data)}),this.recorder.start(),this.toggleUi(!0),this.startTimer()}catch(t){console.error(t),alert("Нет прав на доступ к микрофону")}else alert("Media Devices API not supported")}stopRecording(t){this.recorder&&"inactive"!==this.recorder.state&&(this.recorder.stop(),this.stream.getTracks().forEach(t=>t.stop())),this.stopTimer(),this.toggleUi(!1),t&&setTimeout(()=>{const t=new Blob(this.chunks,{type:"audio/webm"});this.onSaveCallback(t)},100)}toggleUi(t){t?(this.startBtn.parentElement.classList.add("hidden"),this.ui.classList.remove("hidden")):(this.startBtn.parentElement.classList.remove("hidden"),this.ui.classList.add("hidden"))}startTimer(){this.seconds=0,this.timerEl.innerText="00:00",this.timerInterval=setInterval(()=>{this.seconds++;const t=Math.floor(this.seconds/60).toString().padStart(2,"0"),e=(this.seconds%60).toString().padStart(2,"0");this.timerEl.innerText=`${t}:${e}`},1e3)}stopTimer(){clearInterval(this.timerInterval)}}const s=document.querySelector("#timeline-widget"),r=new class{constructor(t){this.container=t,this.postsList=t.querySelector("#posts-list"),this.input=t.querySelector("#text-input"),this.modal=new e(document.querySelector("#modal")),this.audioRecorder=new i(t,this.handleAudio.bind(this))}init(){this.input.addEventListener("keydown",t=>{"Enter"===t.key&&this.input.value.trim()&&(this.handleTextPost(this.input.value),this.input.value="")}),this.audioRecorder.init()}async getPosition(){return new Promise((t,e)=>{navigator.geolocation||e(new Error("Geolocation not supported")),navigator.geolocation.getCurrentPosition(e=>{t({latitude:e.coords.latitude,longitude:e.coords.longitude})},t=>{e(t)})})}async getCoordsOrAskUser(){try{return await this.getPosition()}catch(e){return console.log("Geo API failed, asking user:",e),t(await this.modal.show())}}async handleTextPost(t){try{const e=await this.getCoordsOrAskUser();this.createPost({type:"text",content:t,coords:e})}catch(t){console.error("Post creation cancelled",t)}}async handleAudio(t){try{const e=await this.getCoordsOrAskUser(),i=URL.createObjectURL(t);this.createPost({type:"audio",content:i,coords:e})}catch(t){console.error("Audio creation cancelled",t)}}createPost({type:t,content:e,coords:i}){const s=document.createElement("div");s.classList.add("post");const r=(o=Date.now(),new Date(o).toLocaleString("ru-RU",{day:"2-digit",month:"2-digit",year:"2-digit",hour:"2-digit",minute:"2-digit"}));var o;const n=`[${i.latitude.toFixed(5)}, ${i.longitude.toFixed(5)}]`;let a="";"text"===t?a=`<div class="post-content">${e}</div>`:"audio"===t&&(a=`<audio controls src="${e}"></audio>`),s.innerHTML=`\n            ${a}\n            <div class="post-meta">\n                <span>${n}</span>\n                <span>${r}</span>\n            </div>\n        `,this.postsList.insertBefore(s,this.postsList.firstChild)}}(s);r.init()})();